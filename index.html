<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Профилирование JS</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="shower/themes/ribbon/styles/styles.css">
    <style>
        .shower {
            --slide-ratio: calc(16 / 9);
        }

        .slide h2 {
            font-size: 40px;
        }

        .big-image {
            max-width: 100%;
            max-height: 100%;
        }
    </style>
</head>
<body class="shower list">

<header class="caption">
    <h1>
        Профилирование JS:<br>
        увидеть самое важное и не утонуть в море чисел
    </h1>
    <p>Виктор Хомяков, Яндекс</p>
</header>

<section class="slide">
    <h2>
        Профилирование JS:<br>
        увидеть самое важное
        и не утонуть в море чисел
    </h2>
    <p>Виктор Хомяков, Яндекс</p>
</section>

<!-- вступление -->
<!-- почему именно я рассказываю именно об этой теме и какой у меня опыт в данной области -->
<section class="slide">
    <h2>О себе</h2>
    <p>
        Я профессионально занимаюсь анализом и улучшением производительности страницы поиска в Яндексе
        (Search Engine Result Page, он же SERP или просто серп).
    </p>
</section>

<section class="slide">
    <figure>
        <img src="pictures/serp-sample.jpg" alt="SERP sample" class="cover">
    </figure>
</section>

<!-- почему аудитории важно послушать мой доклад -->
<section class="slide">
    <h2>Профилирование: высокий порог входа</h2>
    <p>
        В область анализа производительности порог входа выше, чем в просто написание работающего кода.
        Запустить профайлер в нужное время и в нужном месте &mdash; проблема.
        Разобраться в полученных результатах &mdash; проблема намного сложнее.
    </p>
</section>

<section class="slide">
    <figure>
        <img src="pictures/js-profiler-client-tree.png" alt="JS Profiler Tree" class="cover">
    </figure>
</section>

<section class="slide">
    <p>
        Анализ чисел &mdash; это тяжело и медленно
    </p>
</section>

<section class="slide">
    <p>
        Анализ изображения &mdash; это быстро, мозг человека хорошо умеет распознавать закономерности и "особые места".
    </p>
</section>

<section class="slide">
    <figure>
        <img src="pictures/js-profiler-client-flame-chart.png" alt="JS Profiler Flame Chart" class="cover">
    </figure>
</section>

<!--
<section class="slide">
    <figure>
        <img src="pictures/average-sample-table.png" alt="Table" class="cover">
    </figure>
</section>

<section class="slide">
    <figure>
        <img src="pictures/average-sample-chart.png" alt="Chart" class="cover">
    </figure>
</section>
-->

<!-- какую пользу получит слушатель от моего выступления -->
<section class="slide">
    <h2>О чём я хочу рассказать</h2>
    <ul>
        <li>анализировать изображение удобнее, чем просматривать море чисел</li>
        <li class="next">есть способы облегчить задачу профилирования и ускорения кода</li>
        <li class="next">результаты профилирования почти всегда можно представить визуально</li>
    </ul>
</section>

<!-- основная часть -->

<!-- React на вкладке Performance -->
<section class="slide">
    <h2 class="shout shrink">Если у меня<br>React</h2>
</section>

<section class="slide">
    <p>
        <a href="https://yandex.ru/search/?text=%D0%B3%D0%B8%D1%84%D0%BA%D0%B8%20%D1%81%D0%B0%D0%BB%D1%8E%D1%82%D1%8B%20%D1%84%D0%B5%D0%B9%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%BA%D0%B8&noredirect=1&lr=213">
            React на серпе Яндекса
        </a>
    </p>
    <figure>
        <img src="pictures/serp-react-sample.png" alt="SERP React sample" class="big-image">
    </figure>
</section>

<section class="slide">
    <figure>
        <img src="pictures/serp-react-performance.png" alt="React Performance" class="cover">
    </figure>
</section>

<section class="slide">
    <p>
        Во время разработки используем development-сборку React DOM:<br>
        react-dom.development.js вместо react-dom.production.min.js
    </p>
</section>

<!--
<section class="slide">
    <figure>
        <img src="pictures/serp-react-dev-performance.png" alt="React Dev Performance" class="cover">
    </figure>
</section>
-->

<section class="slide">
    <h2>Было</h2>
    <figure>
        <img src="pictures/serp-react-performance-zoom.png" alt="SERP React Performance zoomed" class="big-image">
    </figure>
</section>

<section class="slide">
    <h2>Стало</h2>
    <figure>
        <img src="pictures/serp-react-dev-performance-zoom.png" alt="SERP React Dev Performance zoomed"
            class="big-image">
    </figure>
</section>

<section class="slide">
    <h2>Профилирование компонентов React</h2>
    <ul>
        <li>Development-сборка React DOM (react-dom.development.js)</li>
        <li class="next">
            <a href="https://reactjs.org/docs/optimizing-performance.html#profiling-components-with-the-chrome-performance-tab">
                Статья на reactjs.org о профилировании компонентов React в Chrome
            </a>
        </li>
        <li class="next">
            <a href="https://github.com/facebook/react/blob/4a635785f5cc40bde901ada6090904fdc8cc120d/packages/react-reconciler/src/ReactDebugFiberPerf.js#L80-L101">ReactDebugFiberPerf.js</a>
            (собирается в react-dom.development.js)
        </li>
    </ul>
</section>

<!-- Свои таймлайны на вкладке Performance -->
<section class="slide">
    <h2 class="shout shrink">Если у меня<br>нет React</h2>
</section>

<section class="slide">
    <h2>Хочу такое же в свой уютненький проектик!</h2>
    <ul>
        <li>
            <a href="https://developer.mozilla.org/en-US/docs/Web/API/User_Timing_API">
                Статья про User Timing API на MDN
            </a>
        </li>
        <li class="next">
            <code>console.timeStamp(label);</code>
        </li>
        <li class="next">
            <code>console.time(label); console.timeEnd(label)</code>
        </li>
        <li class="next">
            <code>performance.mark(markName);</code>
        </li>
        <li class="next">
            <code>performance.measure(label, markName);</code>
        </li>
    </ul>
</section>

<section class="slide">
    <p>
        TODO добавить скриншоты с console.* и performance.*
    </p>
</section>

<section class="slide">
    <h2>Несколько особенностей</h2>
    <ul>
        <li>
            <code>console.*</code> пишет результат в консоль &mdash; это может замедлить ваш код, если консоль открыта
        </li>
        <li class="next">
            <code>performance.*</code> пишет в performance entries &mdash; надо чистить, чтобы он не съел всю
            память:<br>
            <code>performance.clearMarks(markName);</code>
            <code>performance.clearMeasures(label);</code>
        </li>
    </ul>
</section>

<!-- вкладка Profiler -->
<section class="slide">
    <h2 class="shout shrink">
        Если я
        <br>
        <del>в танке</del>
        в Node
    </h2>
</section>

<section class="slide">
    <h2>Node.js Profiler</h2>
    <p>
        В инспекторе для Node нет вкладки Performance, есть только Profiler
    </p>
</section>

<section class="slide">
    <h2>Много чисел &mdash; опять неинтересно</h2>
    <figure>
        <img src="pictures/node-profiler-tree.png" alt="Node.js Profiler Tree" class="big-image">
    </figure>
</section>

<section class="slide">
    <h2>Но есть JS Flame Chart</h2>
    <figure>
        <img src="pictures/node-profiler-flame-chart.png" alt="Node.js Profiler Flame Chart" class="big-image">
    </figure>
</section>

<!-- профилирование раздельных участков кода -->
<section class="slide">
    <h2 class="shout shrink">Изучение отдельного участка кода</h2>
</section>

<section class="slide">
    <p>
        Иногда надо изучить конкретный метод, при этом остальной код "шумит"
    </p>
    <ol>
        <li class="next">
            Оборачиваем код в<br>
            <code>console.profile() ... console.profileEnd()</code>
        </li>
        <li class="next">Экспортируем профайлы (сохраняем JSON на диск)</li>
        <li class="next">
            Мы умеем в JSON
            <a href="https://github.com/victor-homyakov/merge-cpuprofiles">github.com/victor-homyakov/merge-cpuprofiles</a>
        </li>
        <li class="next">Импортируем получившийся объединённый профайл</li>
        <li class="next">Смотрим, что получилось (TODO надо скриншоты?)</li>
        <li class="next">
            <a href="https://chromedevtools.github.io/devtools-protocol/1-2/Profiler#type-Profile">Описание формата
                Profile</a>,
            <a href="https://chromium.googlesource.com/v8/v8/+/master/src/inspector/js_protocol.json#1421">исходники
                V8 Inspector</a>
        </li>
    </ol>
</section>

<!-- custom visualization -->
<section class="slide">
    <h2 class="shout shrink">Хочу свои таймлайны</h2>
</section>

<section class="slide">
    <h2>Хочу свои таймлайны</h2>
    <ol>
        <li>
            Оборачиваем код в замеры времени
            <ul>
                <li>Node: <code>process.hrtime()</code></li>
                <li>Chrome: <code>performance.now()</code></li>
            </ul>
        </li>
        <li class="next">Собираем данные и сохраняем JSON</li>
        <li class="next">Рисуем Timeline в Google Charts</li>
    </ol>
</section>

<section class="slide">
    <h2>1a. Оборачиваем код в замеры времени в Node</h2>
    <pre>
        <code class="comment">// initialOffset - точка отсчёта</code>
        <code>const initialOffset = process.hrtime(), events = [];</code>
        <code class="comment">// время, прошедшее с момента initialOffset</code>
        <code>let start = process.hrtime(initialOffset);</code>
        <code class="comment">// код</code>
        <code>let end = process.hrtime(initialOffset);</code>
        <code>events.push(['имя метода', start, end]);</code>
    </pre>
</section>

<section class="slide">
    <h2>1b. Оборачиваем код в замеры времени в браузере</h2>
    <pre>
        <code class="comment">// точка отсчёта - начало навигации</code>
        <code>let start = performance.now();</code>
        <code class="comment">// код</code>
        <code>let end = performance.now();</code>
        <code>events.push(['имя метода', start, end]);</code>
    </pre>
</section>

<section class="slide">
    <h2>2. Собираем данные и сохраняем JSON</h2>
    <pre>
        <code>fs.writeFileSync(</code>
        <code>    `timeline-${Date.now()}.json`,</code>
        <code>    JSON.stringify(events)</code>
        <code>);</code>
    </pre>
</section>

<section class="slide">
    <h2>3. Рисуем Timeline в Google Charts</h2>
    <p>
        <a href="google-charts-timeline/timeline.html?file=timeline.json">Пример</a>
    </p>
    <p>
        <a href="https://developers.google.com/chart/interactive/docs/gallery/timeline">Документация</a>
    </p>
    <p>
        TODO вставить скриншот
    </p>
</section>

<!-- custom visualization, part 2 -->
<section class="slide">
    <h2 class="shout shrink">Хочу таймлайны, не хочу писать&nbsp;код</h2>
</section>

<section class="slide">
    <h2>Хочу таймлайны, не хочу писать код</h2>
    <ol>
        <li>Собираем данные в формате Trace Event</li>
        <li class="next">Сохраняем в JSON</li>
        <li class="next">Открываем в chrome://tracing (browser://tracing, about:tracing)</li>
    </ol>
</section>

<section class="slide">
    <h2>1. Собираем данные в формате Trace Event</h2>
    <pre>
        <code>traceEvents.push({</code>
        <code>    pid: 1, tid: 1, ph: 'X', name: 'имя метода',</code>
        <code>    ts: startMicroseconds, dur: durationMicroseconds,</code>
        <code>    args: { <span class="comment">// любая детальная информация</span></code>
        <code>        name: 'имя метода',</code>
        <code>        ms: durationMicroseconds / 1000</code>
        <code>    }</code>
        <code>});</code>
    </pre>
</section>

<section class="slide">
    <h2>2. Сохраняем в JSON</h2>
    <pre>
        <code>fs.writeFileSync(</code>
        <code>    `trace-${Date.now()}.json`,</code>
        <code>    JSON.stringify({</code>
        <code>        traceEvents,</code>
        <code>        metaInfoCreated: new Date()</code>
        <code>    })</code>
        <code>);</code>
    </pre>
</section>

<section class="slide">
    <h2>3. Открываем в chrome://tracing</h2>
</section>

<section class="slide">
    <figure>
        <img src="pictures/chrome-tracing-nodejs.png" alt="chrome://tracing" class="cover">
    </figure>
</section>

<section class="slide">
    <ul>
        <li>
            В chrome://tracing можно загрузить любой JSON в правильном формате
        </li>
        <li class="next">
            <a href="https://docs.google.com/document/d/1CvAClvFfyA5R-PhYUmn5OOQtYMH4h6I0nSsKchNAySU/preview">
                Trace Event Format
            </a>
        </li>
        <li class="next">
            <a href="https://www.chromium.org/developers/how-tos/trace-event-profiling-tool/trace-event-reading">
                Understanding about:tracing results
            </a>
        </li>
        <li class="next">
            <a href="https://www.html5rocks.com/en/tutorials/games/abouttracing/">
                Profiling with the about:tracing
            </a>
        </li>
        <li class="next">
            <a href="https://github.com/catapult-project/catapult/tree/master/tracing">
                Standalone trace viewer
            </a>
        </li>
    </ul>
</section>

<section class="slide">
    <h2 class="shout shrink">Заключение</h2>
</section>

<section class="slide">
    <ul>
        <li>
            Анализировать картинки легче, чем числа
        </li>
        <li class="next">
            В стандартных вкладках Performance и Profiler инспектора для Chrome и Node можно визуализировать
            результаты профилирования с учётом специфики любого фреймворка
        </li>
        <li class="next">
            Если этого недостаточно - есть экспорт JSON, описание форматов, можно написать свои
            преобразования и конвертеры и делать импорт в любой доступный универсальный инструмент
            наподобие Google Charts и chrome://tracing
        </li>
    </ul>
</section>

<section class="slide">
    <h2 class="shout shrink">Спасибо! Вопросы?</h2>
</section>

<!--
<section class="slide">
    <h2>P.S. Полезные ссылки</h2>
    <ul>
        <li>Документация по Chrome DevTools: https://developers.google.com/web/tools/chrome-devtools/</li>
        <li>Полезные советы по DevTools: https://umaar.com/dev-tips</li>
    </ul>
</section>
-->

<div class="progress"></div>

<script src="shower/shower.min.js"></script>
</body>
</html>
